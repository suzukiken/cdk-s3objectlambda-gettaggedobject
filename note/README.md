+++
title = "S3 Object Lambdaで特定のタグのついたS3オブジェクトを返す"
date = "2021-04-02"
tags = ["S3 Object Lambda", "Lambda"]
+++

S3 Object Lambdaを使って、指定したタグのついたバージョンのオブジェクトを見つけて、その内容を返す機能を作った。

![img](/img/2021/04/cdks3objectlambda-gettaggedobject.png)

こんなケースに使えたりしないかなと思ったから。

* 完了した取引1件ごとに、S3のオブジェクトとしてデータを保存しておくことにする。
* 一旦終了した取引のほとんどは変更されることはないが、稀になんらかの問題が後から発生して、取引が完全に無くなったり取引の内容が変更になることがある。
* その場合、変更前のS3オブジェクトを上書きして、最新の内容に更新する。
* こうしたことがあるのでS3のバケットではバージョニングをアクティブにしておき、以前の状態が取り出せるようにしておく。
* 売上の集計は月にまとめて行い、その際は月末時点のオブジェクトの内容をもとに集計する。
* この集計の際に使ったオブジェクトのバージョンには、それがわかるように集計した月のタグを残す。
* もし以前に集計した数字の根拠を要求された場合は、月を指定して集計に使われたバージョンのデータを提示できるようにしておく。

と、こんなシステムを作ろうと思った場合に、集計に使われたバージョンのデータを取り出す部分は、S3 Object Lambdaに任せてしまえば楽なのかな、と思ったわけ。

具体的には月を指定するにはオブジェクトの後ろに`@<月>`をつけることで取り出せるようにした。

例 `<取引情報>.txt@202103` : 2021年3月末の集計に使われたデータを返す

ついでにこうした機能もあると良いのではないかと思って、それも同時に実装してみた。

* `<取引番号>.txt@latest` : 最新の集計に使われたデータを返す
* `<取引情報>.txt@earliest` : 最も古い集計に使われたデータを返す
* `<取引情報>.txt@log` : 全ての変更履歴をjsonで返す

[Githubのリポジトリ](https://github.com/suzukiken/cdks3objectlambda-gettaggedobject)

[前回のS3 Object Lambdaのサンプル](/aws/cdks3objectlambda)をベースに作っているので、全てがCDKでデプロイできるわけではなく一部が手作業となる。その手作業部分については、前回の記事を参照のこと。

動作の確認は[このコード](https://github.com/suzukiken/cdks3objectlambda-gettaggedobject/tree/master/test)が使える。

### 作ってみた感想

作る前にわかるだろという気もするけど[S3 Object Lambdaの関数](https://github.com/suzukiken/cdks3objectlambda-gettaggedobject/blob/master/lambda/index.py)は結構めんどさいものになった。それは、

1. オブジェクトのバージョンのリストを得る
2. 一つ一つのオブジェクトのタグを確認する
3. それを順番に並べて目的のバージョンを特定する

という風に何段階かの手間がかかるためで、これはS3のAPIの仕様上仕方がないし、ここを解決するには結局インデックスファイルのようなものを作る必要が出てくるのだと思う。結構何度もAPIコールをするからバージョンの数が増えてくると30秒の制限時間を超えてしまうかもしれない。となるとやっぱりこういう仕組みを作るならDynamo DBやRDSでやる方がずっと楽で安心だなと思った。

というわけで、ともかくやってみたかったことをやってみたけれど成果物としてはこれを利用することはないだろうなあ。

ちなみに本題とは関係ないですが、S3のオブジェクトは移動するとバージョンはついてこないので、その点もこうしたシステムを設計する際に注意が必要だと思った。
